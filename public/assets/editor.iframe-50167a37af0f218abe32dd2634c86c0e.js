(function(){var t,e,i=function(t,e){return function(){return t.apply(e,arguments)}};t=function(){function t(t){this.show_editor=i(this.show_editor,this),this.initialize=i(this.initialize,this),this.create_on_drop=i(this.create_on_drop,this),this.create_on_load=i(this.create_on_load,this),this.manager=t,this.editor.wysiwyg=t.editor.wysiwyg,this.editor.plugin=t.editor.plugin}return t.prototype.template={content:"<div class='editable-content'></div>",control:"<div class='editable-control bootstrap'>\n  <div class='btn-group'>\n    <a href='#' class='edit btn btn-inverse' title='\u7de8\u96c6'><i class='icon-edit'></i></a>\n    <a href='#' class='move btn btn-inverse' title='\u79fb\u52d5'><i class='icon-move'></i></a>\n    <a href='#' class='remove btn btn-inverse' title='\u524a\u9664'><i class='icon-remove'></i></a>\n  </div>\n</div>",popover:"<a href='#' class='accessibility-popover btn btn-inverse' title='\u30a8\u30e9\u30fc\u5185\u5bb9'><i class='icon-ok'></i></a>"},t.prototype.editable_field=null,t.prototype.just_drop=!1,t.prototype.data_type=null,t.prototype.content=null,t.prototype.target=null,t.prototype.control=null,t.prototype.manager=null,t.prototype.editor={wysiwyg:null,plugin:null},t.prototype.create_on_load=function(t,e,i){var n,o,r,a,s,l,c,d;if(this.editable_field=t,r=$(i),r.wrap(this.template.content),r.after(this.template.control),this.target=r,this.content=r.closest("div.editable-content"),this.control=this.content.find("div.editable-control"),a=r.position(),a&&this.control.css("left",a.left),r.hasClass("data-type-plugin")){this.data_type="plugin",r.attr("title","plugin"),s={plugin:["page_list","genre_list","section_news","section_news_by_path","emergency","genre_down_list","genre_news_list","genre_news_list_truncate","section","section_top_list","sitemap","sub_genre_list","counter","event_calendar_calendar","event_calendar_pickup","event_page_list"]};for(l in s)$.inArray(r.attr("name"),s[l])>=0&&r.attr("title",l)}else this.data_type="wysiwyg";return n=this.content.find("[data-content]"),n.length>0&&(o=this.content.find("div.editable-control div.btn-group"),o.append(this.template.popover),d="<ul>",n.each(function(t,e){return d+="<li>"+$(e).attr("data-content")+"</li>",$(e).removeAttr("data-content")}),d+="</ul>",c=o.find("a.accessibility-popover"),c.attr("data-content",d),c.attr("data-contentsize",n.length)),this.initialize(),this},t.prototype.create_on_drop=function(t,e){var i,n,o,r,a,s,l,c,d,p,u,h,g;if(g="#page-content",this.editable_field=t,this.just_drop=!0,r=e.text(),o=e.attr("name"),a=e.attr("data-type"),n=e.attr("data-default"),e.attr("title"),s=$(g+" .widget-item"),h=s.prev(),l=s.next(),d=s.closest(".susanoo-editable-field"),s.remove(),i=d.find(".editable-content").length,"plugin"===a){c=$("<button class='editable data-type-plugin'></button>"),c.attr("name",o),c.attr("title","plugin"),p={plugin:["page_list","genre_list","section_news","section_news_by_path","emergency","genre_down_list","genre_news_list","genre_news_list_truncate","section","section_top_list","sitemap","sub_genre_list","counter","event_calendar_calendar","event_calendar_pickup","event_page_list"]};for(u in p)$.inArray(c.attr("name"),p[u])>=0&&c.attr("title",u);c.text(r),this.data_type="plugin"}else c=$(n),this.data_type="wysiwyg";return this.content=$(this.template.content),this.content.append(c),this.content.append(this.template.control),this.target=this.content.find(".editable"),this.control=this.content.find("div.editable-control"),0===i?d.append(this.content):h&&1===h.length?$(h).after(this.content):$(l).before(this.content),this.initialize(),this.show_editor(),this},t.prototype.initialize=function(){return this.content.mouseenter(function(t){return function(){if(!1===t.editable_field.dragging)return t.control.show()}}(this)),this.content.mouseleave(function(t){return function(){if(!1===t.editable_field.dragging)return t.control.hide()}}(this)),this.control.find(".edit").click(function(t){return function(){return t.show_editor()}}(this)),this.control.find(".remove").click(function(t){return function(){if(confirm("\u6307\u5b9a\u3057\u305f\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u524a\u9664\u3057\u307e\u3059."))return t.manager.disable_save(),t.content.remove(),delete t}}(this)),this},t.prototype.show_editor=function(){this.control.hide(),"wysiwyg"===this.data_type?this.editor.wysiwyg.show(this):"plugin"===this.data_type&&this.editor.plugin.show(this)},t}(),e=function(){function e(){this.html=i(this.html,this),this.add_content=i(this.add_content,this),this.init=i(this.init,this)}return e.prototype.editors=null,e.prototype.dragging=!1,e.prototype.manager=null,e.prototype.wrapper_id=null,e.prototype.field_class=".susanoo-editable-field",e.prototype.drag_target=null,e.prototype.draggable_obj=null,e.prototype.init=function(e){this.wrapper_id="#page-content",this.manager=e,this.dragging=!1,this.drag_target=null,$(".editable").each(function(e){return function(i,n){var o;o=new t(e.manager),o.create_on_load(e,i,n)}}(this)),$(this.field_class).sortable({connectWith:this.field_class,dropOnEmpty:!0,placeholder:"editable-placeholder",handle:".editable-control .move",cursorAt:{left:0,top:0},items:".editable-content",update:function(t){return function(){t.manager.disable_save()}}(this)}),$(this.field_class),this.draggable_obj&&($(".widget-item",parent.document).draggable("destroy"),$(".widget-item",parent.document).off("click"),this.draggable_obj=null),$.support.opacity?this.draggable_obj=$(".widget-item",parent.document).draggable({appendTo:"parent.body",connectToSortable:this.field_class,helper:"clone",cursor:"move",cursorAt:{left:0,top:0},zIndex:9999,iframeFix:!0,start:function(t){return function(){t.dragging=!0}}(this),stop:function(t){return function(e,i){t.dragging=!1,t.manager.disable_save(),t.add_content($(i.helper))}}(this)}):(this.draggable_obj=$(".widget-item",parent.document).draggable({appendTo:"parent.body",connectToSortable:this.field_class,helper:"clone",cursor:"move",cursorAt:{left:0,top:0},zIndex:9999,iframeFix:!0,start:function(t){return function(){t.dragging=!0}}(this),stop:function(t){return function(e,i){t.dragging=!1,t.manager.disable_save(),t.add_content($(i.helper))}}(this)}).click(function(t){return function(e){return t.drag_target?(t.drag_target.data("uiDraggable")._mouseUp(e),t.drag_target.data("uiDraggable")._mouseStop(e),t.drag_target=null):(t.drag_target=$(e.target),t.drag_target.data("uiDraggable")._mouseCapture(e,!0),t.drag_target.data("uiDraggable")._mouseStart(e,!0,!0)),!1}}(this)),$(document).on("mousemove",".susanoo-editable-field",function(t){return function(e){if(t.drag_target)return t.drag_target.data("uiDraggable")._mouseDrag(e)}}(this)),$(this.field_class).click(function(t){return function(){if(t.drag_target)return t.drag_target.trigger("click")}}(this))),$("#accessibility-content").remove(),$("body").append("<div id='accessibility-content' class='bootstrap'></div>"),$(document).off("mouseenter",".accessibility-popover"),$(document).off("mouseleave",".accessibility-popover"),$(document).off("click","a"),$(document).off("submit","form"),$(".accessibility-popover").popover("destroy"),$(".accessibility-popover").popover({html:!0,trigger:"manual",container:"#accessibility-content"}),$(document).on("mouseenter",".accessibility-popover",function(){var t;return t=35+30*$(this).attr("data-contentsize"),$("#accessibility-content").height(t),$(this).popover("show")}),$(document).on("mouseleave",".accessibility-popover",function(){return $(this).popover("hide")}),$(document).on("click","a",function(t){return t.preventDefault(),!1}),$(document).on("submit","form",function(t){return t.preventDefault(),!1}),$("[onclick]").each(function(){return $(this).removeAttr("onclick")})},e.prototype.add_content=function(e){var i;e&&e.is(".widget-item")?(i=new t(this.manager),i.create_on_drop(this,e)):$(e).remove()},e.prototype.html=function(){var t;return $(".accessibility-popover").popover("hide"),t=$(this.wrapper_id).clone(),t.find(".ui-sortable").each(function(){return $(this).removeClass("ui-sortable")}),t.find(".editable-control").each(function(){return $(this).remove()}),t.find(".editable").each(function(){return $(this).css("position",""),$(this).unwrap()}),t.removeAttr("data-content"),t.removeClass("accessibility-error-highlight"),t.find(".accessibility-error-highlight").each(function(){$(this).removeClass("accessibility-error-highlight")}),t.html()},e}(),this.Visitor||(this.Visitor={}),this.Visitor.EditableField=new e}).call(this);