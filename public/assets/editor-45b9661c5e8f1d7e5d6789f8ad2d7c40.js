(function(){var t,e,i,o,a=function(t,e){return function(){return t.apply(e,arguments)}};o=function(){function t(t,e,i,o){var r;null==o&&(o={}),this.close=a(this.close,this),this.cancel=a(this.cancel,this),this.save=a(this.save,this),this.show=a(this.show,this),this.manager=t,this.mobile=i,this.object=$(e),$(e+" .modal-save").click(this.save),$(e+" .modal-cancel").click(this.cancel),o&&(o.body_id&&(this.body_id=o.body_id),o.body_class&&(this.body_class=o.body_class)),r=$("#page_content_page_id").val(),this.filebrowserBrowseUrl+="?page_id="+r,this.filebrowserImageBrowseLinkUrl+="?page_id="+r,this.filebrowserImageBrowseUrl+="?page_id="+r,this.filebrowserImageUploadUrl+="?page_id="+r,this.filebrowserUploadUrl+="?page_id="+r}return t.prototype.wysiwyg_id="wysiwyg-editor",t.prototype.body_id="",t.prototype.body_class="",t.prototype.object=null,t.prototype.content=null,t.prototype.stylesheets=null,t.prototype.mobile=!1,t.prototype.manager=!1,t.prototype.filebrowserBrowseUrl="/susanoo/page_assets/attachment_files",t.prototype.filebrowserImageBrowseLinkUrl="/susanoo/page_assets/images",t.prototype.filebrowserImageBrowseUrl="/susanoo/page_assets/images",t.prototype.filebrowserImageUploadUrl="/susanoo/page_assets/upload_image",t.prototype.filebrowserUploadUrl="/susanoo/page_assets/upload_attachment_file",t.prototype.show=function(t){var e,i,o,a,r,s,n,l;this.content=t,n=this.content.target,r=CKEDITOR.instances[this.wysiwyg_id],r&&r.destroy(!0),n.hasClass("data-type-h")?(l=Toolbar.header,i=CKEDITOR.ENTER_BR,o=!0,s=n.children().get(0).tagName,a=s.toLowerCase()):this.mobile?(l=Toolbar.mobile,i=CKEDITOR.ENTER_P,o=!1,a="p"):(l=Toolbar.div,i=CKEDITOR.ENTER_P,o=!1,a="p;h1;h2;h3;h4;h5;h6;pre;address;div"),e=n.attr("id"),e||(e=this.body_id),r=CKEDITOR.replace(this.wysiwyg_id,{forceEnterMode:o,toolbar:l,removeFormatAttributes:"",contentsCss:this.stylesheets,allowedContent:AllowedContent.standard,format_tags:a,enterMode:i,bodyId:e,bodyClass:this.body_class,height:"300px",resize_enabled:!1,extraPlugins:"language,jisxtable,jisxtabletools,letterspacing",removePlugins:"tabletools,table",language_list:LanguageList,filebrowserBrowseUrl:this.filebrowserBrowseUrl,filebrowserImageBrowseLinkUrl:this.filebrowserImageBrowseLinkUrl,filebrowserImageBrowseUrl:this.filebrowserImageBrowseUrl,filebrowserImageUploadUrl:this.filebrowserImageUploadUrl,filebrowserUploadUrl:this.filebrowserUploadUrl,on:{instanceReady:function(t){var e;return e=t.editor,e.setData(n.html())}}}),this.object.modal({backdrop:"static"}),this.object.modal("show")},t.prototype.save=function(){var t,e;e=CKEDITOR.instances[this.wysiwyg_id],e&&(this.content.just_drop=!1,t=e.getData(),Susanoo.RemoveEmptyTags&&(t=Susanoo.RemoveEmptyTags.block(t)),this.content.target.html(t)),this.manager.disable_save(),this.close()},t.prototype.cancel=function(){this.content.just_drop&&this.content.content.remove(),this.close()},t.prototype.close=function(){this.content=null,this.object.modal("hide")},t}(),i=function(){function t(t,e){this.close=a(this.close,this),this.cancel=a(this.cancel,this),this.save=a(this.save,this),this.show=a(this.show,this),this.manager=t,this.object=$(e),$(e+" .modal-save").click(this.save),$(e+" .modal-cancel").click(this.cancel)}return t.prototype.object=null,t.prototype.content=null,t.prototype.manager=null,t.prototype.show=function(t){var e,i,o,a,r,s;this.content=t,a=this.content.target,i=a.attr("name"),r={plugin:{title:"\u30d7\u30e9\u30b0\u30a4\u30f3\u8a2d\u5b9a"}},this.object.find("#pluginEditorModalLabel").html(r[a.attr("title")].title),o=$("#form-plugin-sample #"+i).html(),this.object.find("#plugin-editor-body").html(o),$("#form-plugin-sample #"+i+".disabled-plugin").length>0?this.object.find(".modal-save").hide():this.object.find(".modal-save").show(),s=a.attr("value"),s&&(e=s.split(","),this.object.find("#plugin-editor-body input, #plugin-editor-body textarea").each(function(){return function(t,i){var o;return"array"===$(i).attr("data-type")?(o=e.slice(t,+e.length+1||9e9),$(i).val(o.join("\n"))):$(i).val(e[t])}}())),this.object.modal({backdrop:"static"}),this.object.modal("show")},t.prototype.save=function(){var t,e,i,o,a,r,s;if(t=[],i=[],this.object.find("#plugin-editor-body input, #plugin-editor-body textarea").each(function(){return function(e,o){var a,r,s,n,l,c;if("array"===$(o).attr("data-type"))if(a=$(o).val())for(c=a.split("\n"),r=0,s=c.length;r<s;r++)(n=c[r])&&t.push(n);else $(o).attr("data-required")&&i.push({elem:o,kind:"data_required_array"});else l=$(o).val(),l?t.push($(o).val()):$(o).attr("data-required")&&i.push({elem:o,kind:"data_required"});return $(o).parent().find(".alert-error").remove()}}()),i.length>0)for(o=JSON.parse('{"data_required":"\u5fc5\u9808\u9805\u76ee\u3067\u3059\u3002\u5165\u529b\u3057\u3066\u4e0b\u3055\u3044\u3002","data_required_array":"\u5fc5\u9808\u9805\u76ee\u3067\u3059\u30021\u3064\u4ee5\u4e0a\u5165\u529b\u3057\u3066\u4e0b\u3055\u3044\u3002"}'),a=0,r=i.length;a<r;a++)e=i[a],s=$("<div/>",{"class":"alert-error"}),$(e.elem).after(s.append(o[e.kind]));else t.length>0&&this.content.target.attr("value",t.join(",")),this.content.just_drop=!1,this.manager.disable_save(),this.close()},t.prototype.cancel=function(){this.content.just_drop&&this.content.content.remove(),this.close()},t.prototype.close=function(){this.content=null,this.object.modal("hide")},t}(),e=function(){function t(t,e,i){this.close=a(this.close,this),this.cancel=a(this.cancel,this),this.save=a(this.save,this),this.show=a(this.show,this),this.manager=t,this.object=$(e),this.post_url=i,$(e+" .modal-save").click(this.save),$(e+" .modal-cancel").click(this.cancel)}return t.prototype.object=null,t.prototype.content=null,t.prototype.post_url=null,t.prototype.manager=null,t.prototype.show=function(){this.object.modal({backdrop:"static"}),this.object.modal("show")},t.prototype.save=function(){var t;t=$("#direct-html-textarea").val(),t&&($.isLoading({text:"\u51e6\u7406\u4e2d"}),this.manager.disable_save(),$.ajax({type:"POST",url:this.post_url,data:{source:t},dataType:"script"})),this.close()},t.prototype.cancel=function(){this.close()},t.prototype.close=function(){this.object.modal("hide")},t}(),t=function(){function t(){this.cleanup=a(this.cleanup,this),this.iframe_loaded=a(this.iframe_loaded,this),this.init_iframe=a(this.init_iframe,this),this.init=a(this.init,this)}return t.prototype.editable_field=null,t.prototype.stylesheets=[],t.prototype.mobile=!1,t.prototype.editor={wysiwyg:null,plugin:null,html:null},t.prototype.init=function(t,a){var r;null==a&&(a={}),r=$("#direct_html").attr("data-url"),this.mobile=t,this.editor.plugin=new i(this,"#modal-plugin-editor"),this.editor.wysiwyg=new o(this,"#modal-wysiwyg-editor",t,a),this.editor.html=new e(this,"#modal-html-editor",r),$("#widgets").disableSelection(),$(document).keydown(function(t){var e,i;if(8===t.keyCode&&(e=t.target.nodeName.toLowerCase(),i=$(t.target),"input"!==e&&"textarea"!==e||i.attr("readonly")||i.is(":disabled")))return!1}),$(document).on("ready",function(){if($("#save_temporarily")[0])return $("<input>").attr({type:"hidden",name:"_save_temporarily"}).appendTo("form#new_page_content")}),$(".col-right .sidebar-collapser").click(function(){$("#col-right-transitions").toggle(),"none"===$("#col-right-transitions").css("display")?($(".col-right .sidebar-collapser").addClass("closed"),$("div.editor").width(),$("div.editor > .col-left").width(),$(".col-center").width("82.5%"),$(".col-right").width("0.5%")):($(".col-right .sidebar-collapser").removeClass("closed"),$(".col-center").width("66.66%"),$(".col-right").width("16.66%"))}),$("#check").click(function(t){return function(e){var i,o;return $.isLoading({text:"\u51e6\u7406\u4e2d"}),!!(i=t.editable_field.html())&&(o=$(e.target).data("params"),o||(o={}),o.page_id=$("#page_content_page_id").val(),o.content=i,$(e.target).data("params",o),!0)}}(this)),$("#save").click(function(t){return function(e){var i,o;$.isLoading({text:"\u51e6\u7406\u4e2d"}),(o=t.editable_field.html())&&(t.mobile?$("#page_content_mobile").val(o):$("#page_content_content").val(o),i=$("<input>").attr({type:"hidden",name:"commit",value:$(e.target).attr("id")}).appendTo("form#new_page_content"),$("form#new_page_content").submit(),i.detach())}}(this)),$("#save_temporarily").click(function(){return function(t){return $("#save").trigger(t)}}()),$("#preview").click(function(t){return function(e){var i,o;return $.isLoading({text:"\u51e6\u7406\u4e2d"}),!!(i=t.editable_field.html())&&(o=$(e.target).data("params"),o||(o={}),o.content=i,$(e.target).data("params",o),!0)}}(this)),$("#copy").click(function(t){return function(e){return t.disable_save(),t.init_iframe($(e.target).attr("data-src")),!1}}(this)),$("#convert").click(function(t){return function(e){var i,o;return t.disable_save(),$.isLoading({text:"\u51e6\u7406\u4e2d"}),!!(i=t.editable_field.html())&&(o=$(e.target).data("params"),o||(o={}),o.page_id=$("#page_content_page_id").val(),o.content=i,$(e.target).data("params",o),!0)}}(this)),$("#direct_html").click(function(t){return function(){return t.editor.html.show(),!1}}(this)),this.init_iframe(),this.col_resize(),Susanoo.EventTimer=!1,$(window).resize(function(t){return function(){return!1!==Susanoo.EventTimer&&clearTimeout(Susanoo.EventTimer),Susanoo.EventTimer=setTimeout(t.col_resize,300)}}(this)),$("[id^=jquery-ui-effect_]").click(function(){return function(t){var e;return e=$(t.target).attr("id"),$("#"+e).css("background-color","#8DC4E9")}}()),$("[id^=editor-modal-save], [id^=editor-modal-cancel]").click(function(){return function(){return $("[id^=jquery-ui-effect_]").each(function(t,e){var i;return i=$(e).attr("id"),$("#"+i).css("background-color","#222222")})}}())},t.prototype.col_resize=function(){var t;t=$("#header").outerHeight(),$(".col-content").height($(window).height()-t-1),t=$(".col-center").outerHeight(),$("iframe.iframe-edit").height(t)},t.prototype.init_iframe=function(t){var e;null==t&&(t=null),$.isLoading({text:"\u8aad\u8fbc\u4e2d"}),null===t&&(t=$("#iframe_path").val()),$("#iframe-edit").remove(),e=$("<iframe />",{id:"iframe-edit","class":"iframe-edit",src:t}).load(function(t){return function(){t.iframe_loaded()}}(this)),e.appendTo(".col-center > .col-content")},t.prototype.iframe_loaded=function(){var t,e;e=document.getElementById("iframe-edit").contentWindow,t=$("#iframe-edit").contents()[0],$(t).keydown(function(t){var e,i;if(8===t.keyCode&&(e=t.target.nodeName.toLowerCase(),i=$(t.target),"input"!==e&&"textarea"!==e||i.attr("readonly")||i.is(":disabled")))return!1}),$("#iframe-edit").contents().find("link[rel=stylesheet]").each(function(t){return function(e,i){return t.stylesheets.push($(i).attr("href"))}}(this)),this.editor.wysiwyg.stylesheets=this.stylesheets,this.cleanup(),this.editable_field=e.Visitor.EditableField,this.editable_field.init(this),$.isLoading("hide")},t.prototype.cleanup=function(){var t,e,i,o,a;o="#page-content",i=$("#iframe-edit").contents().find(o).html(),e=CKEDITOR.htmlParser.fragment.fromHtml(i),a=new CKEDITOR.htmlParser.basicWriter,t=new CKEDITOR.filter(AllowedContent.standard),t.applyTo(e),e.writeHtml(a),i=a.getHtml(),Susanoo.RemoveEmptyTags&&(i=Susanoo.RemoveEmptyTags.all_block(i)),$("#iframe-edit").contents().find(o).html(i)},t.prototype.disable_save=function(){return $("#save").hide(),$("#save-disalbed").show()},t.prototype.enable_save=function(){$("#save-disalbed").hide(),$("#save").show()},t}(),this.Susanoo||(this.Susanoo={}),this.Susanoo.EventTimer=!1,this.Susanoo.EditManager=new t}).call(this);